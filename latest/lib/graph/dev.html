<html>
<head>
  <title>graph test</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js" integrity="sha256-Cjux44IGDGmZwm+qw4rtfj1swD9zdqmja4gaflupI8o=" crossorigin="anonymous"></script>
  <script type="text/javascript" src="_abbreviatenumber.js"></script>
</head>
<body>
  <div class="graph1" style="border:1px solid;width:800px;height:600px;"></div>
  <select>
    <option value="day">day</option>
    <option value="week" selected>week</option>
    <option value="month">month</option>
  </select>
  <div class="info">
    <div>
      Value: <span class="value"></span>
    </div>
    <div class="time">
      <div>
        Under mouse: <span class="under-mouse"></span>
      </div>
      <div>
        Selected in: <span class="selected in"></span>
      </div>
      <div>
        Selected out: <span class="selected out"></span>
      </div>
    </div>
  </div>
  <script src="./line.js"></script>
  <script>
(function() {
  var graph;
  var data = {};

  var valueEl = document.querySelector('.value');
  var underMouseEl = document.querySelector('.under-mouse');
  var selectedInEl = document.querySelector('.selected.in');
  var selectedOutEl = document.querySelector('.selected.out');
  var timespanSelectEl = document.querySelector('select');
  var el = document.querySelector('.graph1');

  function onselection(info) {
    console.info('selection', info);
    selectedInEl.textContent = info.start;
    selectedOutEl.textContent = info.end;
  }

  function onmousemove(position) {
    valueEl.textContent = 'TODO';
    underMouseEl.textContent = position.left + ' ' + position.top;
  }

  function setup(timespan) {
    var interval = 900;
    if (timespan === 'week') {
      interval = 2700;
    }
    else if (timespan === 'week') {
      interval = 12600;
    }

    if (!graph) {
      graph = new window.Sparkline({
        width: el.clientWidth,
        height: el.clientHeight,
        lineColors: ['green', 'red'],
        rulersColor: '#666',
        fontSize: 12,
        lineWidth: 1,
        timespan: timespan,
        interval: interval,
        onselection: onselection,
        onmousemove: onmousemove
      });
      el.appendChild(graph.canvas);
    }

    graph.setData([data.start, data.end], timespan, interval);
  }

  function load(timespan) {
    fetch('./data/' + timespan + '-instance-start.json')
      .then(function(res) {
        return res.json();
      })
      .then(function(json) {
        data.start = json.reverse();

        fetch('./data/' + timespan + '-instance-end.json')
          .then(function(res) {
            return res.json();
          })
          .then(function(json) {
            data.end = json.reverse();

            setup(timespan);
          });
      });
  }

  timespanSelectEl.addEventListener('change', function() {
    load(timespanSelectEl.value);
  }, false);
  load('week');
})();
  </script>
</body>
</html>